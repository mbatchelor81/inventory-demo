name: SonarQube Security Scan

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  security-scan:
    name: SonarQube Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      checks: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Cache SonarQube packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar
      
      - name: Build and test backend
        run: |
          cd backend
          mvn clean verify
      
      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Run frontend tests with coverage
        run: |
          cd frontend
          CI=true npm test -- --coverage --watchAll=false
      
      - name: SonarQube Scan
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          cd backend
          mvn sonar:sonar \
            -Dsonar.projectKey=mbatchelor81_inventory-demo \
            -Dsonar.organization=mbatchelor81 \
            -Dsonar.host.url=https://sonarcloud.io
      
      - name: Quality Gate Check
        id: quality-gate
        continue-on-error: true
        uses: SonarSource/sonarqube-quality-gate-action@master
        timeout-minutes: 5
        with:
          scanMetadataReportFile: backend/target/sonar/report-task.txt
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      
      - name: Check if Devin Remediation Commit
        id: check-devin
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # For PRs, check the latest commit on the PR branch
            git fetch origin ${{ github.head_ref }}
            COMMIT_AUTHOR=$(git log -1 --format='%an' origin/${{ github.head_ref }})
            COMMIT_MSG=$(git log -1 --format='%s' origin/${{ github.head_ref }})
            echo "Checking PR commit - Author: $COMMIT_AUTHOR"
            echo "Commit message: $COMMIT_MSG"
          else
            # For push events, use the head commit
            COMMIT_AUTHOR="${{ github.event.head_commit.author.name }}"
            COMMIT_MSG="${{ github.event.head_commit.message }}"
            echo "Checking push commit - Author: $COMMIT_AUTHOR"
          fi
          
          # Check for Devin AI commits (exact match) or [devin-remediation] tag
          if [[ "$COMMIT_AUTHOR" == "Devin AI" ]] || [[ "$COMMIT_MSG" == *"[devin-remediation]"* ]]; then
            echo "is_devin_commit=true" >> $GITHUB_OUTPUT
            echo "ü§ñ Detected Devin remediation commit - skipping new session trigger"
          else
            echo "is_devin_commit=false" >> $GITHUB_OUTPUT
            echo "üë§ Human commit detected"
          fi
      
      - name: Extract Quality Gate Failure Details
        id: extract-issues
        if: steps.quality-gate.outcome == 'failure'
        run: |
          echo "üìä Extracting quality gate failure details from SonarQube..."
          
          # Determine if this is a PR or branch scan
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            PR_PARAM="&pullRequest=${{ github.event.pull_request.number }}"
          else
            PR_PARAM=""
          fi
          
          # Extract all issue types (VULNERABILITY, BUG, CODE_SMELL, SECURITY_HOTSPOT)
          ALL_ISSUES=$(curl -s -u "${{ secrets.SONAR_TOKEN }}:" \
            "https://sonarcloud.io/api/issues/search?componentKeys=mbatchelor81_inventory-demo${PR_PARAM}&resolved=false&ps=100")
          
          # Get quality gate status details
          QG_STATUS=$(curl -s -u "${{ secrets.SONAR_TOKEN }}:" \
            "https://sonarcloud.io/api/qualitygates/project_status?projectKey=mbatchelor81_inventory-demo${PR_PARAM}")
          
          # Extract metrics
          VULNERABILITIES=$(echo "$ALL_ISSUES" | jq '[.issues[] | select(.type=="VULNERABILITY")] | length')
          BUGS=$(echo "$ALL_ISSUES" | jq '[.issues[] | select(.type=="BUG")] | length')
          CODE_SMELLS=$(echo "$ALL_ISSUES" | jq '[.issues[] | select(.type=="CODE_SMELL")] | length')
          SECURITY_HOTSPOTS=$(echo "$ALL_ISSUES" | jq '[.issues[] | select(.type=="SECURITY_HOTSPOT")] | length')
          TOTAL_ISSUES=$(echo "$ALL_ISSUES" | jq '.total')
          
          # Extract failed conditions from quality gate
          FAILED_CONDITIONS=$(echo "$QG_STATUS" | jq -c '[.projectStatus.conditions[] | select(.status=="ERROR") | {metric: .metricKey, actual: .actualValue, threshold: .errorThreshold}]')
          
          # Create comprehensive issue summary
          ISSUE_SUMMARY=$(echo "$ALL_ISSUES" | jq -c --arg vuln "$VULNERABILITIES" --arg bugs "$BUGS" --arg smells "$CODE_SMELLS" --arg hotspots "$SECURITY_HOTSPOTS" '{
            total: .total,
            vulnerabilities: ($vuln | tonumber),
            bugs: ($bugs | tonumber),
            code_smells: ($smells | tonumber),
            security_hotspots: ($hotspots | tonumber),
            issues: [.issues[] | {
              key: .key,
              type: .type,
              severity: .severity,
              message: .message,
              component: .component,
              line: .line,
              rule: .rule
            }]
          }')
          
          echo "total_issues=$TOTAL_ISSUES" >> $GITHUB_OUTPUT
          echo "vulnerabilities=$VULNERABILITIES" >> $GITHUB_OUTPUT
          echo "bugs=$BUGS" >> $GITHUB_OUTPUT
          echo "code_smells=$CODE_SMELLS" >> $GITHUB_OUTPUT
          echo "security_hotspots=$SECURITY_HOTSPOTS" >> $GITHUB_OUTPUT
          
          echo "issue_summary<<EOF" >> $GITHUB_OUTPUT
          echo "$ISSUE_SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "failed_conditions<<EOF" >> $GITHUB_OUTPUT
          echo "$FAILED_CONDITIONS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "‚ö†Ô∏è  Quality Gate Failures:"
          echo "   - Total Issues: $TOTAL_ISSUES"
          echo "   - Vulnerabilities: $VULNERABILITIES"
          echo "   - Bugs: $BUGS"
          echo "   - Code Smells: $CODE_SMELLS"
          echo "   - Security Hotspots: $SECURITY_HOTSPOTS"
      
      - name: Trigger Devin Remediation (Human PR Only)
        id: trigger-devin
        if: |
          steps.quality-gate.outcome == 'failure' && 
          steps.check-devin.outputs.is_devin_commit == 'false' &&
          github.event_name == 'pull_request'
        env:
          DEVIN_API_KEY: ${{ secrets.DEVIN_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ü§ñ Triggering Devin AI Quality Gate Remediation Specialist..."
          
          TOTAL_ISSUES="${{ steps.extract-issues.outputs.total_issues }}"
          VULNERABILITIES="${{ steps.extract-issues.outputs.vulnerabilities }}"
          BUGS="${{ steps.extract-issues.outputs.bugs }}"
          CODE_SMELLS="${{ steps.extract-issues.outputs.code_smells }}"
          SECURITY_HOTSPOTS="${{ steps.extract-issues.outputs.security_hotspots }}"
          ISSUE_SUMMARY='${{ steps.extract-issues.outputs.issue_summary }}'
          FAILED_CONDITIONS='${{ steps.extract-issues.outputs.failed_conditions }}'
          
          # System prompt - defines Devin's role and expertise
          SYSTEM_PROMPT="You are a SonarQube Quality Gate Remediation Specialist with comprehensive expertise in:
          
          **Security & Vulnerabilities:**
          - OWASP Top 10 vulnerabilities (SQL injection, XSS, authentication flaws, etc.)
          - Secure coding practices for Java Spring Boot and JavaScript/React
          - Cryptographic best practices and secure random number generation
          - Input validation, output encoding, and sanitization
          - Dependency vulnerability management
          
          **Code Quality & Reliability:**
          - Bug detection and resolution (null pointer exceptions, resource leaks, logic errors)
          - Exception handling best practices
          - Proper use of language features and APIs
          - Thread safety and concurrency issues
          
          **Maintainability:**
          - Code smells and technical debt reduction
          - Unused imports, variables, and dead code removal
          - Code complexity reduction and refactoring
          - Proper naming conventions and code organization
          
          **Test Coverage:**
          - Unit test creation using JUnit 5 and Mockito
          - Integration test development with Spring Boot Test
          - Achieving and maintaining coverage thresholds (80%+)
          - Testing edge cases, error paths, and business logic
          
          **Tools & Access:**
          - You have access to the SonarQube MCP server and SONAR_TOKEN for direct REST API access to query detailed issue information
          - Use the MCP server to get comprehensive details about ALL issues, not just vulnerabilities
          - Query for quality gate status, failed conditions, and coverage metrics
          
          **CRITICAL WORKFLOW INSTRUCTIONS:**
          1. Commit ALL fixes in a SINGLE commit to the current branch
          2. DO NOT create a new pull request
          3. MUST tag your commit message with [devin-remediation] prefix
          4. Run all tests (mvn test) before committing to ensure nothing breaks
          5. Your commit will trigger an automatic re-scan - DO NOT trigger manually"
          
          # User prompt - specific task with comprehensive quality gate details
          USER_PROMPT="# SonarQube Quality Gate Remediation - PR #${{ github.event.pull_request.number }}

          ## Quality Gate Status
          ‚ùå **FAILED** - Quality gate conditions not met

          ## Issue Summary
          - **Total Issues:** ${TOTAL_ISSUES}
          - **Vulnerabilities:** ${VULNERABILITIES} üî¥
          - **Bugs:** ${BUGS} üêõ
          - **Code Smells:** ${CODE_SMELLS} üí®
          - **Security Hotspots:** ${SECURITY_HOTSPOTS} üî•
          - **Project:** mbatchelor81_inventory-demo
          - **Branch:** ${{ github.head_ref }}
          - **PR:** #${{ github.event.pull_request.number }}

          ## Failed Quality Gate Conditions
          \`\`\`json
          ${FAILED_CONDITIONS}
          \`\`\`

          ## Your Mission

          ### Phase 1: Comprehensive Analysis (Use SonarQube MCP Server or SONAR_TOKEN for REST API Access)
          
          **CRITICAL:** Use the SonarQube MCP server or SONAR_TOKEN for REST API access to analyze ALL aspects of the quality gate failure:
          
          1. **Query the quality gate status** to understand which specific conditions failed:
             - New reliability rating (bugs)
             - New security rating (vulnerabilities)
             - New maintainability rating (code smells)
             - New coverage percentage
             - New duplicated lines density
             - Security hotspots reviewed percentage
          
          2. **Retrieve detailed issue information** for each category:
             - Get all VULNERABILITY issues with severity, location, and remediation guidance
             - Get all BUG issues with root cause analysis
             - Get all CODE_SMELL issues that impact maintainability
             - Get all SECURITY_HOTSPOT issues requiring review
          
          3. **Analyze coverage gaps:**
             - Identify which files/methods lack test coverage
             - Determine what tests need to be added to reach 80%+ coverage threshold

          ### Phase 2: Implement Comprehensive Fixes

          **Security & Vulnerabilities:**
          - SQL injection ‚Üí Use parameterized queries or JPA repository methods
          - XSS ‚Üí Implement input validation and output encoding
          - Weak cryptography ‚Üí Use SHA-256+ instead of MD5, SecureRandom instead of Random
          - Path traversal ‚Üí Validate and sanitize file paths
          - Authentication/authorization ‚Üí Follow Spring Security best practices
          - Dependency vulnerabilities ‚Üí Update to patched versions

          **Bugs & Reliability:**
          - Null pointer exceptions ‚Üí Add null checks or use Optional
          - Resource leaks ‚Üí Use try-with-resources for AutoCloseable objects
          - Logic errors ‚Üí Fix incorrect conditionals, loops, or calculations
          - Generic exceptions ‚Üí Replace with specific exception types
          - Unused code ‚Üí Remove unused imports, variables, methods

          **Code Smells & Maintainability:**
          - Remove unused imports, variables, and dead code
          - Simplify complex methods (reduce cognitive complexity)
          - Fix improper exception handling
          - Improve naming conventions
          - Reduce code duplication

          **Test Coverage:**
          - Add unit tests for uncovered methods using JUnit 5 + Mockito
          - Focus on business logic, edge cases, and error paths
          - Ensure new code has 80%+ coverage
          - Test both success and failure scenarios
          - Mock dependencies appropriately

          ### Phase 3: Validation
          - Run \`cd backend && mvn clean test\` to verify all tests pass
          - Run \`cd frontend && npm test\` if frontend changes made
          - Ensure build completes successfully with no errors
          - Verify fixes address the root cause, not just symptoms

          ### Phase 4: Single Commit (CRITICAL)
          - **Commit message format:** \`fix: [devin-remediation] Resolve SonarQube quality gate failures\`
          - **Commit body must include:**
            * Summary: Fixed ${VULNERABILITIES} vulnerabilities, ${BUGS} bugs, ${CODE_SMELLS} code smells
            * List of SonarQube issue keys resolved (e.g., java:S1234, javascript:S5678)
            * Coverage improvement: X% ‚Üí Y%
            * Brief description of major changes
          - **Push to branch:** \`${{ github.head_ref }}\`
          - **This triggers automatic re-scan - DO NOT manually trigger**

          ## Resources
          - üìä [SonarQube Dashboard](https://sonarcloud.io/dashboard?id=mbatchelor81_inventory-demo)
          - üîß [GitHub Actions Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - üìñ [SonarQube Rules](https://rules.sonarsource.com/)

          ## Detailed Issue Data
          \`\`\`json
          ${ISSUE_SUMMARY}
          \`\`\`

          ## Success Criteria (ALL must be met)
          ‚úÖ All vulnerabilities resolved (security rating = A)
          ‚úÖ All bugs fixed (reliability rating = A)
          ‚úÖ Critical code smells addressed (maintainability rating = A)
          ‚úÖ Test coverage ‚â• 80% on new code
          ‚úÖ All security hotspots reviewed
          ‚úÖ All tests pass
          ‚úÖ Quality gate passes on re-scan
          ‚úÖ No new issues introduced

          ## Important Notes
          - This is a SINGLE-PASS remediation - fix everything comprehensively
          - Do NOT commit partial fixes that will trigger another Devin session
          - If coverage is the issue, prioritize adding tests over fixing minor code smells
          - Always verify the actual quality gate conditions that failed before starting work"
          
          # Create Devin session via API
          DEVIN_SESSION=$(curl -s -X POST "https://api.devin.ai/v1/sessions" \
            -H "Authorization: Bearer $DEVIN_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg name "SonarQube Quality Gate Remediation - PR #${{ github.event.pull_request.number }}" \
              --arg repo "${{ github.server_url }}/${{ github.repository }}" \
              --arg branch "${{ github.head_ref }}" \
              --arg system_prompt "$SYSTEM_PROMPT" \
              --arg user_prompt "$USER_PROMPT" \
              '{
                name: $name,
                repo_url: $repo,
                branch: $branch,
                system_prompt: $system_prompt,
                prompt: $user_prompt,
                mcp_servers: ["sonarqube"]
              }')")
          
          SESSION_ID=$(echo "$DEVIN_SESSION" | jq -r '.session_id')
          SESSION_URL=$(echo "$DEVIN_SESSION" | jq -r '.url')
          
          if [ "$SESSION_ID" == "null" ] || [ -z "$SESSION_ID" ]; then
            echo "‚ùå Failed to create Devin session"
            echo "$DEVIN_SESSION"
          else
            echo "‚úÖ Devin session created successfully"
            echo "   Session ID: $SESSION_ID"
            echo "   Session URL: $SESSION_URL"
            
            # Post comment to PR
            cat << EOF > devin-comment.md
          ## ü§ñ Devin AI Quality Gate Remediation Triggered
          
          A SonarQube Quality Gate Remediation Specialist (Devin AI) has been assigned to comprehensively fix all quality gate failures.
          
          ### üìä Quality Gate Analysis
          - **Total Issues:** ${TOTAL_ISSUES}
          - **Vulnerabilities:** ${VULNERABILITIES} üî¥
          - **Bugs:** ${BUGS} üêõ
          - **Code Smells:** ${CODE_SMELLS} üí®
          - **Security Hotspots:** ${SECURITY_HOTSPOTS} üî•
          - **Quality Gate Status:** ‚ùå Failed
          
          ### üîó Links
          - [üëÄ Monitor Devin Session]($SESSION_URL)
          - [üìä SonarQube Dashboard](https://sonarcloud.io/dashboard?id=mbatchelor81_inventory-demo)
          - [üîß GitHub Actions Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          ---
          
          **Note:** Devin will push a single comprehensive fix to this branch. The workflow will automatically re-run to validate that the quality gate passes.
          
          **Expected Outcome:** All quality gate conditions met in one remediation cycle.
          EOF
            
            gh pr comment ${{ github.event.pull_request.number }} --body-file devin-comment.md
          fi
      
      - name: Fail if Quality Gate Failed
        if: steps.quality-gate.outcome == 'failure'
        run: |
          if [[ "${{ steps.check-devin.outputs.is_devin_commit }}" == "true" ]]; then
            echo "‚ùå Quality gate still failing after Devin remediation"
            echo "üîç Human review required"
            echo ""
            echo "Possible reasons:"
            echo "  - Complex vulnerabilities requiring architectural changes"
            echo "  - False positives that need manual review"
            echo "  - New issues introduced during remediation"
            echo "  - Issues requiring human judgment"
            echo ""
            echo "Next steps:"
            echo "  1. Review the SonarQube report"
            echo "  2. Check Devin's commit and changes"
            echo "  3. Manually address remaining vulnerabilities"
            echo "  4. Consider marking false positives in SonarQube"
          else
            echo "‚ùå Quality gate failed"
            echo "ü§ñ Devin AI has been triggered to remediate vulnerabilities"
            echo "‚è≥ Waiting for Devin to commit fixes..."
          fi
          exit 1
