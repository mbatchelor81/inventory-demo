name: SonarQube Security Scan

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  security-scan:
    name: SonarQube Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      checks: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Cache SonarQube packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar
      
      - name: Build and test backend
        run: |
          cd backend
          mvn clean verify
      
      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Run frontend tests with coverage
        run: |
          cd frontend
          CI=true npm test -- --coverage --watchAll=false
      
      - name: SonarQube Scan
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          cd backend
          mvn sonar:sonar \
            -Dsonar.projectKey=mbatchelor81_inventory-demo \
            -Dsonar.organization=mbatchelor81 \
            -Dsonar.host.url=https://sonarcloud.io
      
      - name: Quality Gate Check
        id: quality-gate
        continue-on-error: true
        uses: SonarSource/sonarqube-quality-gate-action@master
        timeout-minutes: 5
        with:
          scanMetadataReportFile: backend/target/sonar/report-task.txt
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      
      - name: Check if Devin Remediation Commit
        id: check-devin
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          COMMIT_AUTHOR="${{ github.event.head_commit.author.name }}"
          
          if [[ "$COMMIT_MSG" == *"[devin-remediation]"* ]] || [[ "$COMMIT_AUTHOR" == "devin"* ]]; then
            echo "is_devin_commit=true" >> $GITHUB_OUTPUT
            echo "ü§ñ Detected Devin remediation commit"
          else
            echo "is_devin_commit=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Extract Vulnerability Details
        id: extract-vulns
        if: steps.quality-gate.outcome == 'failure'
        run: |
          echo "üìä Extracting vulnerability details from SonarQube..."
          
          VULN_RESPONSE=$(curl -s -u "${{ secrets.SONAR_TOKEN }}:" \
            "https://sonarcloud.io/api/issues/search?componentKeys=mbatchelor81_inventory-demo&types=VULNERABILITY&resolved=false&ps=50")
          
          VULN_COUNT=$(echo "$VULN_RESPONSE" | jq '.total')
          VULN_DETAILS=$(echo "$VULN_RESPONSE" | jq -c '{total: .total, issues: [.issues[] | {key: .key, severity: .severity, message: .message, component: .component, line: .line, type: .type}]}')
          
          echo "vulnerability_count=$VULN_COUNT" >> $GITHUB_OUTPUT
          echo "vulnerability_details<<EOF" >> $GITHUB_OUTPUT
          echo "$VULN_DETAILS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "‚ö†Ô∏è  Found $VULN_COUNT vulnerabilities"
      
      - name: Trigger Devin Remediation (Human PR Only)
        id: trigger-devin
        if: |
          steps.quality-gate.outcome == 'failure' && 
          steps.check-devin.outputs.is_devin_commit == 'false' &&
          github.event_name == 'pull_request'
        env:
          DEVIN_API_KEY: ${{ secrets.DEVIN_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ü§ñ Triggering Devin AI Security Vulnerability Remediation Specialist..."
          
          VULN_COUNT="${{ steps.extract-vulns.outputs.vulnerability_count }}"
          VULN_DETAILS='${{ steps.extract-vulns.outputs.vulnerability_details }}'
          
          # System prompt - defines Devin's role and expertise
          SYSTEM_PROMPT="You are a Security Vulnerability Remediation Specialist with expertise in:
          - OWASP Top 10 vulnerabilities
          - Secure coding practices (Java Spring Boot, JavaScript/React)
          - Dependency vulnerability management
          - Code security analysis and remediation
          
          Your task is to remediate security vulnerabilities detected by SonarQube.
          You have access to the SonarQube MCP server to query detailed vulnerability information.
          
          CRITICAL INSTRUCTIONS:
          - Commit your fixes to the current branch
          - DO NOT create a new pull request
          - Tag your commit with [devin-remediation] in the message
          - Ensure all tests pass before committing"
          
          # User prompt - specific task with vulnerability details
          USER_PROMPT="# Security Vulnerability Remediation - PR #${{ github.event.pull_request.number }}

          ## Quality Gate Status
          ‚ùå **FAILED** - Security vulnerabilities detected

          ## Vulnerability Summary
          - **Total Vulnerabilities:** ${VULN_COUNT}
          - **Project:** mbatchelor81_inventory-demo
          - **Branch:** ${{ github.head_ref }}
          - **PR:** #${{ github.event.pull_request.number }}

          ## Your Mission

          ### 1. Analyze Vulnerabilities
          - Use the SonarQube MCP server to get detailed information
          - Review severity levels (CRITICAL, HIGH, MEDIUM, LOW)
          - Understand the security impact of each issue

          ### 2. Implement Fixes
          - Fix each vulnerability following OWASP best practices
          - For SQL injection: Use parameterized queries
          - For XSS: Implement proper input validation and output encoding
          - For authentication issues: Follow secure authentication patterns
          - For dependency vulnerabilities: Update to patched versions
          - Ensure fixes don't break existing functionality

          ### 3. Testing
          - Run all existing tests: \`mvn test\` (backend) and \`npm test\` (frontend)
          - Add security-specific tests where appropriate
          - Verify the build passes completely

          ### 4. Commit Your Changes
          - **Commit message:** \`fix: [devin-remediation] Resolve ${VULN_COUNT} SonarQube vulnerabilities\`
          - **Include in commit body:**
            * List of SonarQube issue keys fixed
            * Brief description of each fix
            * Any dependencies updated
          - **Push to branch:** \`${{ github.head_ref }}\`
          - **This will trigger a re-scan automatically**

          ## Resources
          - üìä [SonarQube Dashboard](https://sonarcloud.io/dashboard?id=mbatchelor81_inventory-demo)
          - üîß [GitHub Actions Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ## Vulnerability Details
          \`\`\`json
          ${VULN_DETAILS}
          \`\`\`

          ## Success Criteria
          - All vulnerabilities resolved
          - Quality gate passes on re-scan
          - All tests pass
          - No new vulnerabilities introduced"
          
          # Create Devin session via API
          DEVIN_SESSION=$(curl -s -X POST "https://api.devin.ai/v1/sessions" \
            -H "Authorization: Bearer $DEVIN_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg name "CVE Remediation - PR #${{ github.event.pull_request.number }}" \
              --arg repo "${{ github.server_url }}/${{ github.repository }}" \
              --arg branch "${{ github.head_ref }}" \
              --arg system_prompt "$SYSTEM_PROMPT" \
              --arg user_prompt "$USER_PROMPT" \
              '{
                name: $name,
                repo_url: $repo,
                branch: $branch,
                system_prompt: $system_prompt,
                prompt: $user_prompt,
                mcp_servers: ["sonarqube"]
              }')")
          
          SESSION_ID=$(echo "$DEVIN_SESSION" | jq -r '.session_id')
          SESSION_URL=$(echo "$DEVIN_SESSION" | jq -r '.url')
          
          if [ "$SESSION_ID" == "null" ] || [ -z "$SESSION_ID" ]; then
            echo "‚ùå Failed to create Devin session"
            echo "$DEVIN_SESSION"
          else
            echo "‚úÖ Devin session created successfully"
            echo "   Session ID: $SESSION_ID"
            echo "   Session URL: $SESSION_URL"
            
            # Post comment to PR
            cat << EOF > devin-comment.md
          ## ü§ñ Devin AI Security Remediation Triggered
          
          A Security Vulnerability Remediation Specialist (Devin AI) has been assigned to fix the detected vulnerabilities.
          
          ### üìä Scan Results
          - **Vulnerabilities Found:** ${VULN_COUNT}
          - **Quality Gate Status:** ‚ùå Failed
          
          ### üîÑ What's Happening
          1. ‚úÖ SonarQube scan completed
          2. ü§ñ Devin analyzing vulnerabilities via SonarQube MCP server
          3. üîß Implementing fixes following OWASP best practices
          4. ‚è≥ Will commit fixes to this branch (triggers automatic re-scan)
          
          ### üîó Links
          - [üëÄ Monitor Devin Session]($SESSION_URL)
          - [üìä SonarQube Report](https://sonarcloud.io/dashboard?id=mbatchelor81_inventory-demo)
          - [üîß GitHub Actions Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          ---
          
          **Note:** Devin will push fixes to this branch. The workflow will automatically re-run to validate the remediation.
          
          **For Devin-initiated PRs:** Devin monitors CI checks natively and self-remediates without API calls.
          EOF
            
            gh pr comment ${{ github.event.pull_request.number }} --body-file devin-comment.md
          fi
      
      - name: Fail if Quality Gate Failed
        if: steps.quality-gate.outcome == 'failure'
        run: |
          if [[ "${{ steps.check-devin.outputs.is_devin_commit }}" == "true" ]]; then
            echo "‚ùå Quality gate still failing after Devin remediation"
            echo "üîç Human review required"
            echo ""
            echo "Possible reasons:"
            echo "  - Complex vulnerabilities requiring architectural changes"
            echo "  - False positives that need manual review"
            echo "  - New issues introduced during remediation"
            echo "  - Issues requiring human judgment"
            echo ""
            echo "Next steps:"
            echo "  1. Review the SonarQube report"
            echo "  2. Check Devin's commit and changes"
            echo "  3. Manually address remaining vulnerabilities"
            echo "  4. Consider marking false positives in SonarQube"
          else
            echo "‚ùå Quality gate failed"
            echo "ü§ñ Devin AI has been triggered to remediate vulnerabilities"
            echo "‚è≥ Waiting for Devin to commit fixes..."
          fi
          exit 1
